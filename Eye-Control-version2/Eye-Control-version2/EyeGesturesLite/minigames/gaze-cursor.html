<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cursor Controlado por Mirada</title>
    <script src="https://webgazer.cs.brown.edu/webgazer.js"></script>
    <script src="gazeTrail.js"></script>
    <script src="globalGazeTrail.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f1faee 0%, #a8dadc 50%, #457b9d 100%);
            min-height: 100vh;
            overflow: hidden;
            cursor: none; /* Ocultar cursor normal */
        }

        /* Mensaje superior */
        .message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(241, 250, 238, 0.98);
            color: #1d3557;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.2rem;
            font-weight: bold;
            z-index: 9999;
            box-shadow: 0 4px 20px rgba(69, 123, 157, 0.3);
            animation: float 3s ease-in-out infinite;
            border: 2px solid rgba(168, 218, 220, 0.5);
        }

        @keyframes float {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-10px); }
        }

        /* Cursor personalizado */
        #gaze-cursor {
            position: fixed;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(69, 123, 157, 0.8) 0%, rgba(69, 123, 157, 0.3) 50%, transparent 100%);
            border: 3px solid rgba(241, 250, 238, 0.9);
            pointer-events: none;
            z-index: 10000;
            transition: all 0.1s ease-out;
            box-shadow: 0 0 30px rgba(69, 123, 157, 0.6), 
                        0 0 60px rgba(69, 123, 157, 0.4),
                        inset 0 0 20px rgba(241, 250, 238, 0.3);
            transform: translate(-50%, -50%);
            display: none;
        }

        #gaze-cursor.active {
            display: block;
        }

        #gaze-cursor::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
        }

        #gaze-cursor::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px dashed rgba(255, 255, 255, 0.5);
            animation: rotate 4s linear infinite;
        }

        @keyframes rotate {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* Trail del cursor */
        .cursor-trail {
            position: fixed;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(94, 23, 235, 0.3);
            pointer-events: none;
            z-index: 9998;
            animation: fade-out 1s forwards;
        }

        @keyframes fade-out {
            to {
                opacity: 0;
                transform: scale(0.5);
            }
        }

        /* Panel de control */
        .control-panel {
            position: fixed;
            top: 120px;
            left: 20px;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 25px;
            border-radius: 15px;
            min-width: 280px;
            z-index: 9999;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .control-panel h3 {
            margin-bottom: 20px;
            font-size: 1.3rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .control-item {
            margin: 15px 0;
        }

        .control-item label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .btn {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        input[type="range"] {
            width: 100%;
            margin: 10px 0;
        }

        .stat-value {
            color: #667eea;
            font-weight: bold;
            font-size: 1.2rem;
        }

        /* Elementos interactivos */
        .interactive-area {
            position: fixed;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            color: white;
            font-size: 1.3rem;
            font-weight: bold;
            transition: all 0.3s;
            cursor: none;
        }

        .interactive-area:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.8);
            transform: scale(1.05);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .interactive-area.clicked {
            background: rgba(76, 175, 80, 0.4);
            border-color: #4CAF50;
        }

        #target1 {
            top: 30%;
            right: 20%;
            width: 200px;
            height: 150px;
        }

        #target2 {
            bottom: 25%;
            left: 15%;
            width: 220px;
            height: 160px;
        }

        #target3 {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 250px;
            height: 180px;
        }

        /* Calibraci√≥n */
        .calibration-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10001;
        }

        .calibration-overlay.show {
            display: flex;
        }

        .calibration-content {
            text-align: center;
            color: white;
        }

        .calibration-content h2 {
            font-size: 2.5rem;
            margin-bottom: 30px;
        }

        .calibration-content p {
            font-size: 1.3rem;
            margin: 15px 0;
        }

        /* Estad√≠sticas en tiempo real */
        .stats-display {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 20px;
            border-radius: 15px;
            min-width: 250px;
            z-index: 9999;
        }

        .stats-display h4 {
            margin-bottom: 15px;
            color: #667eea;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Efectos de part√≠culas */
        .particle {
            position: fixed;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            pointer-events: none;
            z-index: 9997;
            animation: particle-float 2s ease-out forwards;
        }

        @keyframes particle-float {
            to {
                opacity: 0;
                transform: translateY(-100px);
            }
        }

        /* Indicador de dwell time */
        .dwell-indicator {
            position: fixed;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 4px solid transparent;
            border-top-color: #4CAF50;
            pointer-events: none;
            z-index: 9999;
            transform: translate(-50%, -50%);
            display: none;
            animation: spin 1s linear infinite;
        }

        .dwell-indicator.active {
            display: block;
        }

        @keyframes spin {
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="message">
        üëÅÔ∏è Cursor controlado por tu mirada
    </div>

    <div id="gaze-cursor"></div>
    <div id="dwell-indicator" class="dwell-indicator"></div>

    <div class="control-panel">
        <h3>‚öôÔ∏è Controles</h3>
        
        <button id="start-btn" class="btn btn-primary" onclick="startGazeCursor()">
            ‚ñ∂Ô∏è Iniciar
        </button>
        <button id="stop-btn" class="btn btn-secondary" onclick="stopGazeCursor()" disabled>
            ‚è∏Ô∏è Pausar
        </button>

        <div class="control-item">
            <label>Suavidad del Movimiento:</label>
            <input type="range" id="smoothness" min="1" max="20" value="5" oninput="updateSmoothness(this.value)">
            <small style="color: #667eea;"><span id="smoothness-value">5</span> (1=r√°pido, 20=suave)</small>
        </div>

        <div class="control-item">
            <label>Tama√±o del Cursor:</label>
            <input type="range" id="cursor-size" min="30" max="100" value="60" oninput="updateCursorSize(this.value)">
            <small style="color: #667eea;"><span id="size-value">60</span>px</small>
        </div>

        <div class="control-item">
            <label>
                <input type="checkbox" id="trail-toggle" onchange="toggleTrail(this.checked)" checked>
                Mostrar Rastro
            </label>
        </div>

        <div class="control-item">
            <label>
                <input type="checkbox" id="dwell-toggle" onchange="toggleDwell(this.checked)" checked>
                Dwell Click (mirar 2s)
            </label>
        </div>
    </div>

    <div class="stats-display">
        <h4>üìä Estad√≠sticas</h4>
        <div class="stat-row">
            <span>Posici√≥n X:</span>
            <span class="stat-value" id="pos-x">0</span>
        </div>
        <div class="stat-row">
            <span>Posici√≥n Y:</span>
            <span class="stat-value" id="pos-y">0</span>
        </div>
        <div class="stat-row">
            <span>Precisi√≥n:</span>
            <span class="stat-value" id="accuracy">--</span>
        </div>
        <div class="stat-row">
            <span>FPS:</span>
            <span class="stat-value" id="fps">0</span>
        </div>
        <div class="stat-row">
            <span>Clicks:</span>
            <span class="stat-value" id="click-count">0</span>
        </div>
    </div>

    <!-- √Åreas interactivas -->
    <div class="interactive-area" id="target1" data-name="Target 1">
        üéØ Mira aqu√≠<br>2 segundos
    </div>
    <div class="interactive-area" id="target2" data-name="Target 2">
        ‚≠ê Objetivo 2<br>Fija tu mirada
    </div>
    <div class="interactive-area" id="target3" data-name="Target 3">
        üíé Centro<br>Click con mirada
    </div>

    <div class="calibration-overlay" id="calibration-overlay">
        <div class="calibration-content">
            <h2>üëÅÔ∏è Calibraci√≥n Inicial</h2>
            <p>Por favor, sigue las instrucciones en pantalla</p>
            <p style="font-size: 1rem; opacity: 0.8; margin-top: 30px;">
                Haz clic en los puntos que aparecer√°n para calibrar el sistema
            </p>
        </div>
    </div>

    <script>
        let isActive = false;
        let cursor = null;
        let dwellIndicator = null;
        let smoothness = 5;
        let cursorSize = 60;
        let showTrail = true;
        let dwellEnabled = true;
        let clickCount = 0;

        // Suavizado del cursor
        let targetX = 0;
        let targetY = 0;
        let currentX = 0;
        let currentY = 0;

        // Dwell time
        let dwellTarget = null;
        let dwellStartTime = null;
        const DWELL_DURATION = 2000; // 2 segundos

        // FPS counter
        let frameCount = 0;
        let lastFpsUpdate = Date.now();

        async function startGazeCursor() {
            console.log('üöÄ Iniciando cursor por mirada...');

            const startBtn = document.getElementById('start-btn');
            const stopBtn = document.getElementById('stop-btn');
            const calibOverlay = document.getElementById('calibration-overlay');

            try {
                startBtn.disabled = true;
                calibOverlay.classList.add('show');

                // Inicializar WebGazer
                await webgazer.setGazeListener((data, timestamp) => {
                    if (data && isActive) {
                        targetX = data.x;
                        targetY = data.y;
                        frameCount++;
                    }
                }).begin();

                // Configurar WebGazer
                webgazer.showVideoPreview(true)
                    .showPredictionPoints(false)
                    .applyKalmanFilter(true);

                // Esperar calibraci√≥n
                setTimeout(() => {
                    calibOverlay.classList.remove('show');
                    isActive = true;
                    stopBtn.disabled = false;

                    cursor = document.getElementById('gaze-cursor');
                    dwellIndicator = document.getElementById('dwell-indicator');
                    cursor.classList.add('active');

                    // Iniciar animaci√≥n del cursor
                    requestAnimationFrame(updateCursor);

                    // Actualizar FPS
                    setInterval(updateFPS, 1000);

                    console.log('‚úÖ Cursor activo');
                }, 5000);

            } catch (error) {
                console.error('‚ùå Error:', error);
                alert('Error al iniciar: ' + error.message);
                startBtn.disabled = false;
                calibOverlay.classList.remove('show');
            }
        }

        function stopGazeCursor() {
            isActive = false;
            webgazer.pause();

            document.getElementById('start-btn').disabled = false;
            document.getElementById('stop-btn').disabled = true;
            
            if (cursor) {
                cursor.classList.remove('active');
            }

            console.log('‚è∏Ô∏è Cursor pausado');
        }

        function updateCursor() {
            if (!isActive) return;

            // Aplicar suavizado (interpolaci√≥n lineal)
            const smoothFactor = smoothness / 20;
            currentX += (targetX - currentX) * (1 - smoothFactor);
            currentY += (targetY - currentY) * (1 - smoothFactor);

            // Actualizar posici√≥n del cursor
            if (cursor) {
                cursor.style.left = currentX + 'px';
                cursor.style.top = currentY + 'px';

                // Trail effect
                if (showTrail && Math.random() < 0.3) {
                    createTrail(currentX, currentY);
                }
            }

            // Actualizar estad√≠sticas
            document.getElementById('pos-x').textContent = Math.round(currentX);
            document.getElementById('pos-y').textContent = Math.round(currentY);

            // Dwell time detection
            if (dwellEnabled) {
                checkDwellClick(currentX, currentY);
            }

            requestAnimationFrame(updateCursor);
        }

        function createTrail(x, y) {
            const trail = document.createElement('div');
            trail.className = 'cursor-trail';
            trail.style.left = x + 'px';
            trail.style.top = y + 'px';
            document.body.appendChild(trail);

            setTimeout(() => {
                trail.remove();
            }, 1000);
        }

        function checkDwellClick(x, y) {
            const element = document.elementFromPoint(x, y);
            
            if (element && element.classList.contains('interactive-area')) {
                if (dwellTarget !== element) {
                    // Nuevo target
                    dwellTarget = element;
                    dwellStartTime = Date.now();
                    
                    if (dwellIndicator) {
                        dwellIndicator.classList.add('active');
                        dwellIndicator.style.left = x + 'px';
                        dwellIndicator.style.top = y + 'px';
                    }
                } else {
                    // Mismo target, verificar tiempo
                    const elapsed = Date.now() - dwellStartTime;
                    
                    if (elapsed >= DWELL_DURATION) {
                        // Dwell click!
                        performDwellClick(element);
                        dwellTarget = null;
                        dwellStartTime = null;
                        
                        if (dwellIndicator) {
                            dwellIndicator.classList.remove('active');
                        }
                    }
                }
            } else {
                // Fuera del target
                if (dwellTarget) {
                    dwellTarget = null;
                    dwellStartTime = null;
                    
                    if (dwellIndicator) {
                        dwellIndicator.classList.remove('active');
                    }
                }
            }
        }

        function performDwellClick(element) {
            clickCount++;
            document.getElementById('click-count').textContent = clickCount;

            // Efecto visual
            element.classList.add('clicked');
            
            // Part√≠culas
            for (let i = 0; i < 20; i++) {
                setTimeout(() => createParticle(currentX, currentY), i * 20);
            }

            setTimeout(() => {
                element.classList.remove('clicked');
            }, 1000);

            const name = element.getAttribute('data-name');
            console.log(`üéØ Dwell click en: ${name}`);
        }

        function createParticle(x, y) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.style.left = (x + (Math.random() - 0.5) * 50) + 'px';
            particle.style.top = (y + (Math.random() - 0.5) * 50) + 'px';
            document.body.appendChild(particle);

            setTimeout(() => {
                particle.remove();
            }, 2000);
        }

        function updateSmoothness(value) {
            smoothness = parseInt(value);
            document.getElementById('smoothness-value').textContent = value;
        }

        function updateCursorSize(value) {
            cursorSize = parseInt(value);
            document.getElementById('size-value').textContent = value;
            
            if (cursor) {
                cursor.style.width = value + 'px';
                cursor.style.height = value + 'px';
            }
        }

        function toggleTrail(enabled) {
            showTrail = enabled;
        }

        function toggleDwell(enabled) {
            dwellEnabled = enabled;
            if (!enabled && dwellIndicator) {
                dwellIndicator.classList.remove('active');
            }
        }

        function updateFPS() {
            const fps = frameCount;
            frameCount = 0;
            document.getElementById('fps').textContent = fps;
            
            // Calcular precisi√≥n aproximada
            let accuracy = 'Alta';
            if (fps < 15) accuracy = 'Baja';
            else if (fps < 25) accuracy = 'Media';
            
            document.getElementById('accuracy').textContent = accuracy;
        }

        // Prevenir scroll
        document.body.style.overflow = 'hidden';
    </script>
</body>
</html>
